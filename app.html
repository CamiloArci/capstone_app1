<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FourSight Group Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #1abc9c;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #27ae60;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            color: var(--accent-color);
        }

        .file-upload-area {
            border: 3px dashed var(--secondary-color);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f8fafc;
            margin-bottom: 20px;
        }

        .file-upload-area:hover {
            background-color: #e8f4fc;
            border-color: var(--accent-color);
        }

        .file-upload-area i {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 15px;
        }

        .file-upload-area p {
            margin-bottom: 10px;
        }

        .file-upload-area span {
            color: var(--secondary-color);
            font-weight: bold;
        }

        #fileInput {
            display: none;
        }

        .btn {
            display: inline-block;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s;
            margin-top: 15px;
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: #d68910;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-danger {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 5px solid var(--danger-color);
            color: #c0392b;
        }

        .alert-success {
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 5px solid var(--success-color);
            color: #27ae60;
        }

        .alert-info {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 5px solid var(--secondary-color);
            color: var(--secondary-color);
        }

        .alert-warning {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 5px solid var(--warning-color);
            color: #d35400;
        }

        .alert i {
            font-size: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
            padding: 15px;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e8f4fc;
        }

        .role-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-right: 5px;
        }

        .role-1 {
            background-color: #d5f4e6;
            color: #27ae60;
        }

        .role-2 {
            background-color: #fef9e7;
            color: #f39c12;
        }

        .role-3 {
            background-color: #eaf2f8;
            color: #3498db;
        }

        .integrator {
            background-color: #fdedec;
            color: #e74c3c;
            font-weight: bold;
        }

        .incomplete-data {
            background-color: #f9f9f9;
            color: #999;
            font-style: italic;
        }

        .incomplete-data td {
            opacity: 0.6;
        }

        .group-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 900px) {
            .group-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .group-container {
                grid-template-columns: 1fr;
            }
        }

        .group-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            border-top: 5px solid var(--accent-color);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .group-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .group-size {
            background-color: var(--secondary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .student-list {
            list-style-type: none;
        }

        .student-item {
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-name {
            font-weight: 500;
        }

        .summary-stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            flex: 1;
            min-width: 150px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .profile-distribution {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .profile-count {
            text-align: center;
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            color: white;
            font-weight: bold;
        }

        .clarificador { background-color: #3498db; }
        .ideador { background-color: #9b59b6; }
        .desarrollador { background-color: #1abc9c; }
        .implementador { background-color: #e74c3c; }

        .instructions {
            background-color: #fff9e6;
            border-left: 5px solid var(--warning-color);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 30px;
        }

        .instructions h3 {
            color: var(--warning-color);
            margin-bottom: 10px;
        }

        .instructions ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .dialog-content {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .hidden {
            display: none !important;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sample-data-link {
            color: var(--secondary-color);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
        }

        .sample-data-link:hover {
            color: var(--primary-color);
        }

        .students-without-data {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #bdc3c7;
        }

        .students-without-data h4 {
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .students-without-data ul {
            list-style-type: none;
            max-height: 150px;
            overflow-y: auto;
        }

        .students-without-data li {
            padding: 5px 0;
            border-bottom: 1px dashed #ddd;
        }

        .students-without-data li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-users"></i> FourSight Group Builder</h1>
        <p class="subtitle">Aplicación para crear grupos de trabajo equilibrados basados en perfiles cognitivos FourSight</p>
    </header>

    <div class="instructions">
        <h3><i class="fas fa-info-circle"></i> Instrucciones</h3>
        <ul>
            <li>Carga un archivo Excel (.xlsx) con los puntajes FourSight de 22 estudiantes</li>
            <li>El archivo debe contener las columnas: <strong>Nombre, Clarificador, Ideador, Desarrollador, Implementador</strong></li>
            <li>Los estudiantes con datos faltantes en cualquier columna de puntajes serán excluidos del análisis</li>
            <li>La aplicación formará automáticamente 6 grupos: 4 grupos de 4 personas y 2 grupos de 5 personas</li>
            <li>El algoritmo prioriza la diversidad cognitiva y maneja empates mediante análisis de preferencias secundarias</li>
        </ul>
        <p><i class="fas fa-lightbulb"></i> <strong>Sugerencia:</strong> Puedes probar la aplicación con <a class="sample-data-link" id="loadSampleData">datos de ejemplo</a>.</p>
    </div>

    <div class="container">
        <div class="card">
            <h2><i class="fas fa-file-upload"></i> Cargar Datos</h2>
            <div class="file-upload-area" id="dropArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Arrastra y suelta tu archivo Excel aquí o</p>
                <label for="fileInput" class="btn">Seleccionar Archivo</label>
                <input type="file" id="fileInput" accept=".xlsx, .xls">
                <p><span>Formato requerido:</span> .xlsx con 22 estudiantes</p>
            </div>
            
            <div id="validationAlert" class="alert hidden">
                <i class="fas fa-exclamation-triangle"></i>
                <div id="validationMessage"></div>
            </div>
            
            <button id="processBtn" class="btn btn-success" disabled>
                <i class="fas fa-cogs"></i> Procesar y Crear Grupos
            </button>
            
            <div id="processingIndicator" class="loader hidden"></div>
            
            <div id="studentsWithoutData" class="students-without-data hidden">
                <h4><i class="fas fa-exclamation-circle"></i> Estudiantes excluidos por datos incompletos</h4>
                <ul id="excludedStudentsList"></ul>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-chart-bar"></i> Resumen de Datos</h2>
            <div id="summaryContent">
                <p style="text-align: center; color: #7f8c8d; padding: 40px 0;">
                    <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #bdc3c7;"></i>
                    Carga un archivo para ver el resumen de datos y distribución de perfiles
                </p>
            </div>
            
            <div class="summary-stats hidden" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">Total Estudiantes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="validStudents">0</div>
                    <div class="stat-label">Con datos completos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="excludedStudents">0</div>
                    <div class="stat-label">Excluidos</div>
                </div>
            </div>
            
            <div class="profile-distribution hidden" id="profileDistribution">
                <!-- Los perfiles se insertarán aquí con JavaScript -->
            </div>
        </div>
    </div>
    
    <div class="card hidden" id="resultsCard">
        <h2><i class="fas fa-users-cog"></i> Grupos Formados</h2>
        <div class="group-container" id="groupsContainer">
            <!-- Los grupos se insertarán aquí con JavaScript -->
        </div>
        
        <div style="margin-top: 30px;">
            <h3><i class="fas fa-table"></i> Detalle de Estudiantes</h3>
            <div style="overflow-x: auto;">
                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Clarificador</th>
                            <th>Ideador</th>
                            <th>Desarrollador</th>
                            <th>Implementador</th>
                            <th>Perfil Primario</th>
                            <th>Perfil Secundario</th>
                            <th>Grupo</th>
                            <th>Rol Asignado</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <!-- Las filas se insertarán aquí con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Diálogo de confirmación para continuar con menos de 22 estudiantes -->
    <div id="confirmationDialog" class="confirmation-dialog hidden">
        <div class="dialog-content">
            <h3><i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i> Advertencia: Datos insuficientes</h3>
            <p id="confirmationMessage"></p>
            <p><strong>¿Desea continuar con el procesamiento con los datos disponibles?</strong></p>
            <div class="dialog-buttons">
                <button id="cancelProcessBtn" class="btn btn-danger">Cancelar</button>
                <button id="confirmProcessBtn" class="btn btn-success">Continuar</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>FourSight Group Builder - Aplicación para Distribución Equilibrada de Grupos</p>
        <p>Desarrollado para la asignatura Capstone Design Project</p>
        <p><i class="fas fa-code"></i> Implementación de lógica multicapa: Preferencia primaria, gestión de saturación y análisis de brecha</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Variables globales
        let studentsData = [];
        let validStudentsData = [];
        let excludedStudentsData = [];
        let groups = [];
        let fileLoaded = false;

        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const processBtn = document.getElementById('processBtn');
        const validationAlert = document.getElementById('validationAlert');
        const validationMessage = document.getElementById('validationMessage');
        const summaryContent = document.getElementById('summaryContent');
        const statsContainer = document.getElementById('statsContainer');
        const profileDistribution = document.getElementById('profileDistribution');
        const resultsCard = document.getElementById('resultsCard');
        const groupsContainer = document.getElementById('groupsContainer');
        const studentsTableBody = document.getElementById('studentsTableBody');
        const processingIndicator = document.getElementById('processingIndicator');
        const loadSampleDataLink = document.getElementById('loadSampleData');
        const totalStudentsElement = document.getElementById('totalStudents');
        const validStudentsElement = document.getElementById('validStudents');
        const excludedStudentsElement = document.getElementById('excludedStudents');
        const excludedStudentsList = document.getElementById('excludedStudentsList');
        const studentsWithoutDataDiv = document.getElementById('studentsWithoutData');
        const confirmationDialog = document.getElementById('confirmationDialog');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const cancelProcessBtn = document.getElementById('cancelProcessBtn');
        const confirmProcessBtn = document.getElementById('confirmProcessBtn');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            fileInput.addEventListener('change', handleFileSelect);
            processBtn.addEventListener('click', processData);
            loadSampleDataLink.addEventListener('click', loadSampleData);
            cancelProcessBtn.addEventListener('click', hideConfirmationDialog);
            confirmProcessBtn.addEventListener('click', confirmProcessWithAvailableData);
            
            // Drag and drop functionality
            dropArea.addEventListener('dragover', handleDragOver);
            dropArea.addEventListener('drop', handleFileDrop);
            dropArea.addEventListener('dragleave', handleDragLeave);
        });

        // Funciones para drag and drop
        function handleDragOver(e) {
            e.preventDefault();
            dropArea.style.backgroundColor = '#e8f4fc';
            dropArea.style.borderColor = 'var(--accent-color)';
        }

        function handleDragLeave() {
            dropArea.style.backgroundColor = '#f8fafc';
            dropArea.style.borderColor = 'var(--secondary-color)';
        }

        function handleFileDrop(e) {
            e.preventDefault();
            dropArea.style.backgroundColor = '#f8fafc';
            dropArea.style.borderColor = 'var(--secondary-color)';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect({ target: fileInput });
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validar extensión del archivo
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showValidationAlert('Por favor, selecciona un archivo Excel (.xlsx o .xls)', 'danger');
                return;
            }
            
            // Mostrar nombre del archivo
            dropArea.innerHTML = `
                <i class="fas fa-file-excel" style="color: #1d6f42;"></i>
                <p><strong>${file.name}</strong></p>
                <p>Haz clic en "Procesar y Crear Grupos" para continuar</p>
            `;
            
            // Leer el archivo Excel
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    validateAndProcessData(jsonData);
                } catch (error) {
                    showValidationAlert('Error al leer el archivo Excel. Asegúrate de que el formato sea correcto.', 'danger');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function validateAndProcessData(data) {
            // Validar que hay datos
            if (!data || data.length === 0) {
                showValidationAlert('El archivo no contiene datos o está vacío.', 'danger');
                return;
            }
            
            // Validar columnas requeridas
            const requiredColumns = ['Nombre', 'Clarificador', 'Ideador', 'Desarrollador', 'Implementador'];
            const firstRow = data[0];
            const missingColumns = requiredColumns.filter(col => !Object.keys(firstRow).includes(col));
            
            if (missingColumns.length > 0) {
                showValidationAlert(`Faltan columnas requeridas: ${missingColumns.join(', ')}`, 'danger');
                return;
            }
            
            // Separar estudiantes con datos completos e incompletos
            validStudentsData = [];
            excludedStudentsData = [];
            
            data.forEach((student, index) => {
                // Verificar si todos los campos de puntaje tienen valores válidos (no vacíos, no null, no undefined)
                const clarificador = student.Clarificador;
                const ideador = student.Ideador;
                const desarrollador = student.Desarrollador;
                const implementador = student.Implementador;
                
                const hasCompleteData = 
                    clarificador !== undefined && clarificador !== null && clarificador !== '' &&
                    ideador !== undefined && ideador !== null && ideador !== '' &&
                    desarrollador !== undefined && desarrollador !== null && desarrollador !== '' &&
                    implementador !== undefined && implementador !== null && implementador !== '';
                
                if (hasCompleteData) {
                    // Determinar perfil primario y secundario
                    const profiles = [
                        { name: 'Clarificador', score: parseInt(clarificador) },
                        { name: 'Ideador', score: parseInt(ideador) },
                        { name: 'Desarrollador', score: parseInt(desarrollador) },
                        { name: 'Implementador', score: parseInt(implementador) }
                    ];
                    
                    // Ordenar por puntaje descendente
                    profiles.sort((a, b) => b.score - a.score);
                    
                    const primaryProfile = profiles[0];
                    const secondaryProfile = profiles[1];
                    const tertiaryProfile = profiles[2];
                    
                    // Calcular delta entre primario y secundario
                    const delta = primaryProfile.score - secondaryProfile.score;
                    
                    // Identificar si es integrador (empate en puntajes máximos)
                    const topScore = primaryProfile.score;
                    const topProfiles = profiles.filter(p => p.score === topScore);
                    const isIntegrator = topProfiles.length > 1;
                    
                    validStudentsData.push({
                        id: validStudentsData.length + 1,
                        name: student.Nombre || `Estudiante ${index + 1}`,
                        clarificador: parseInt(clarificador),
                        ideador: parseInt(ideador),
                        desarrollador: parseInt(desarrollador),
                        implementador: parseInt(implementador),
                        primaryProfile: primaryProfile.name,
                        secondaryProfile: secondaryProfile.name,
                        tertiaryProfile: tertiaryProfile.name,
                        primaryScore: primaryProfile.score,
                        secondaryScore: secondaryProfile.score,
                        delta: delta,
                        isIntegrator: isIntegrator,
                        assignedGroup: null,
                        assignedRole: null,
                        roleType: null, // 1 = primario, 2 = secundario, 3 = terciario
                        hasCompleteData: true
                    });
                } else {
                    // Guardar estudiante excluido
                    excludedStudentsData.push({
                        id: excludedStudentsData.length + 1,
                        name: student.Nombre || `Estudiante ${index + 1}`,
                        clarificador: clarificador,
                        ideador: ideador,
                        desarrollador: desarrollador,
                        implementador: implementador,
                        hasCompleteData: false
                    });
                }
            });
            
            // Actualizar studentsData con todos los estudiantes
            studentsData = [...validStudentsData, ...excludedStudentsData];
            
            // Mostrar información sobre estudiantes excluidos
            if (excludedStudentsData.length > 0) {
                excludedStudentsList.innerHTML = '';
                excludedStudentsData.forEach(student => {
                    const li = document.createElement('li');
                    li.textContent = `${student.name} (Faltan datos)`;
                    excludedStudentsList.appendChild(li);
                });
                studentsWithoutDataDiv.classList.remove('hidden');
            } else {
                studentsWithoutDataDiv.classList.add('hidden');
            }
            
            // Verificar si hay exactamente 22 estudiantes con datos completos
            if (validStudentsData.length === 22) {
                showValidationAlert(`Archivo validado correctamente. ${validStudentsData.length} estudiantes con datos completos encontrados.`, 'success');
                fileLoaded = true;
                processBtn.disabled = false;
                processBtn.textContent = 'Procesar y Crear Grupos';
            } else {
                // Mostrar advertencia pero permitir continuar
                const message = `El archivo contiene ${validStudentsData.length} estudiantes con datos completos (se requieren 22). ${excludedStudentsData.length} estudiantes han sido excluidos por datos incompletos.`;
                showValidationAlert(message, 'warning');
                
                // Permitir continuar pero con advertencia
                fileLoaded = true;
                processBtn.disabled = false;
                processBtn.textContent = `Procesar con ${validStudentsData.length} estudiantes`;
                processBtn.classList.remove('btn-success');
                processBtn.classList.add('btn-warning');
            }
            
            // Actualizar resumen de datos
            updateDataSummary();
        }

        function showValidationAlert(message, type) {
            validationMessage.textContent = message;
            validationAlert.className = `alert alert-${type}`;
            validationAlert.classList.remove('hidden');
            
            // Cambiar icono según tipo
            const icon = validationAlert.querySelector('i');
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else if (type === 'warning') {
                icon.className = 'fas fa-exclamation-triangle';
            } else if (type === 'danger') {
                icon.className = 'fas fa-times-circle';
            } else {
                icon.className = 'fas fa-info-circle';
            }
            
            // Ocultar alerta después de 5 segundos si es éxito
            if (type === 'success') {
                setTimeout(() => {
                    validationAlert.classList.add('hidden');
                }, 5000);
            }
        }

        function updateDataSummary() {
            // Actualizar estadísticas
            const totalStudents = studentsData.length;
            const validStudents = validStudentsData.length;
            const excludedStudents = excludedStudentsData.length;
            
            totalStudentsElement.textContent = totalStudents;
            validStudentsElement.textContent = validStudents;
            excludedStudentsElement.textContent = excludedStudents;
            
            // Mostrar contenedor de estadísticas
            statsContainer.classList.remove('hidden');
            
            // Calcular distribución de perfiles primarios solo para estudiantes válidos
            const profileCounts = {
                'Clarificador': 0,
                'Ideador': 0,
                'Desarrollador': 0,
                'Implementador': 0
            };
            
            validStudentsData.forEach(student => {
                profileCounts[student.primaryProfile]++;
            });
            
            // Actualizar distribución de perfiles
            profileDistribution.innerHTML = '';
            for (const [profile, count] of Object.entries(profileCounts)) {
                const profileClass = profile.toLowerCase();
                const profileElement = document.createElement('div');
                profileElement.className = 'profile-count';
                profileElement.innerHTML = `
                    <div class="profile-icon ${profileClass}">${profile.charAt(0)}</div>
                    <div class="stat-value">${count}</div>
                    <div class="stat-label">${profile}</div>
                `;
                profileDistribution.appendChild(profileElement);
            }
            
            profileDistribution.classList.remove('hidden');
            
            // Actualizar contenido del resumen
            summaryContent.innerHTML = `
                <p><i class="fas fa-check-circle" style="color: ${validStudents === 22 ? 'var(--success-color)' : 'var(--warning-color)'};"></i> 
                ${validStudents} estudiantes con datos completos${validStudents === 22 ? '' : ' (se requieren 22)'}</p>
                ${excludedStudents > 0 ? `<p><i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i> ${excludedStudents} estudiantes excluidos por datos incompletos</p>` : ''}
            `;
        }

        function loadSampleData() {
            // Datos de ejemplo con 22 estudiantes (algunos con datos incompletos)
            const sampleData = [];
            const names = [
                "Juan Pérez", "María López", "Carlos García", "Ana Martínez", "David Rodríguez",
                "Laura Hernández", "Javier González", "Sofía Díaz", "Miguel Sánchez", "Elena Fernández",
                "Daniel Romero", "Carmen Torres", "Alejandro Ruiz", "Isabel Jiménez", "Francisco Morales",
                "Patricia Ortega", "Antonio Navarro", "Raquel Iglesias", "José Ramírez", "Teresa Castro",
                "Manuel Méndez", "Lucía Vega", "Pedro Gómez", "Silvia Reyes"
            ];
            
            // Generar puntajes aleatorios pero con distribución realista
            for (let i = 0; i < 24; i++) { // 24 estudiantes en total
                // Algunos estudiantes tendrán datos incompletos
                const hasIncompleteData = i % 7 === 0; // Aproximadamente 3 estudiantes tendrán datos incompletos
                
                if (hasIncompleteData) {
                    // Estudiante con datos incompletos
                    sampleData.push({
                        Nombre: names[i],
                        Clarificador: i === 0 ? "" : 15,
                        Ideador: i === 7 ? null : 20,
                        Desarrollador: 18,
                        Implementador: i === 14 ? undefined : 12
                    });
                } else {
                    // Generar puntajes que sumen aproximadamente 70
                    const scores = [];
                    let remaining = 70;
                    
                    for (let j = 0; j < 3; j++) {
                        const score = Math.floor(Math.random() * (remaining / (3 - j))) + 10;
                        scores.push(score);
                        remaining -= score;
                    }
                    
                    scores.push(remaining);
                    
                    // Mezclar los puntajes
                    scores.sort(() => Math.random() - 0.5);
                    
                    sampleData.push({
                        Nombre: names[i],
                        Clarificador: scores[0],
                        Ideador: scores[1],
                        Desarrollador: scores[2],
                        Implementador: scores[3]
                    });
                }
            }
            
            // Simular carga de archivo
            validateAndProcessData(sampleData);
            
            // Actualizar área de carga
            dropArea.innerHTML = `
                <i class="fas fa-file-excel" style="color: #1d6f42;"></i>
                <p><strong>datos_ejemplo.xlsx</strong></p>
                <p>Datos de ejemplo cargados. Haz clic en "Procesar y Crear Grupos" para continuar</p>
            `;
        }

        function processData() {
            if (!fileLoaded || validStudentsData.length === 0) {
                showValidationAlert('Primero debes cargar un archivo válido con al menos un estudiante con datos completos.', 'danger');
                return;
            }
            
            // Si no hay exactamente 22 estudiantes con datos completos, mostrar diálogo de confirmación
            if (validStudentsData.length !== 22) {
                showConfirmationDialog();
                return;
            }
            
            // Si hay exactamente 22 estudiantes, procesar directamente
            startProcessing();
        }

        function showConfirmationDialog() {
            const validCount = validStudentsData.length;
            const excludedCount = excludedStudentsData.length;
            
            confirmationMessage.textContent = `
                Se encontraron ${validCount} estudiantes con datos completos (se requieren 22). 
                ${excludedCount} estudiantes han sido excluidos por datos incompletos.
                
                Si continúa, se crearán grupos con los ${validCount} estudiantes disponibles, pero el resultado puede no ser óptimo.
            `;
            
            confirmationDialog.classList.remove('hidden');
        }

        function hideConfirmationDialog() {
            confirmationDialog.classList.add('hidden');
        }

        function confirmProcessWithAvailableData() {
            hideConfirmationDialog();
            startProcessing();
        }

        function startProcessing() {
            // Mostrar indicador de procesamiento
            processingIndicator.classList.remove('hidden');
            processBtn.disabled = true;
            
            // Simular procesamiento (en una aplicación real, esto sería sincrónico)
            setTimeout(() => {
                // Ejecutar algoritmo de formación de grupos
                formGroups();
                
                // Ocultar indicador de procesamiento
                processingIndicator.classList.add('hidden');
                processBtn.disabled = false;
                
                // Restaurar botón a estado normal
                processBtn.classList.remove('btn-warning');
                processBtn.classList.add('btn-success');
                processBtn.textContent = 'Procesar y Crear Grupos';
                
                // Mostrar resultados
                displayResults();
            }, 1500);
        }

        function formGroups() {
            // Inicializar grupos (basado en el número de estudiantes disponibles)
            groups = [];
            const totalStudents = validStudentsData.length;
            
            // Calcular distribución de grupos
            let groupSizes = [];
            if (totalStudents >= 20) {
                // Para 20-22 estudiantes: 4 grupos de 4 y 2 grupos de (total-16)
                groupSizes = [4, 4, 4, 4];
                const remaining = totalStudents - 16;
                if (remaining > 0) groupSizes.push(Math.ceil(remaining/2));
                if (remaining > 0) groupSizes.push(Math.floor(remaining/2));
            } else if (totalStudents >= 15) {
                // Para 15-19 estudiantes: 3 grupos de 4 y 2 grupos de (total-12)
                groupSizes = [4, 4, 4];
                const remaining = totalStudents - 12;
                if (remaining > 0) groupSizes.push(Math.ceil(remaining/2));
                if (remaining > 0) groupSizes.push(Math.floor(remaining/2));
            } else {
                // Para menos de 15 estudiantes: grupos más pequeños
                const numGroups = Math.ceil(totalStudents / 4);
                const baseSize = Math.floor(totalStudents / numGroups);
                let remainder = totalStudents % numGroups;
                
                for (let i = 0; i < numGroups; i++) {
                    groupSizes.push(baseSize + (remainder > 0 ? 1 : 0));
                    if (remainder > 0) remainder--;
                }
            }
            
            // Crear grupos
            for (let i = 1; i <= groupSizes.length; i++) {
                groups.push({
                    id: i,
                    size: groupSizes[i-1],
                    members: [],
                    profiles: {
                        Clarificador: false,
                        Ideador: false,
                        Desarrollador: false,
                        Implementador: false
                    }
                });
            }
            
            // Hacer una copia de los estudiantes válidos para trabajar
            let remainingStudents = [...validStudentsData];
            
            // FASE 1: Asignar perfiles primarios cuando sea posible
            // Ordenar estudiantes por delta descendente (perfiles más "puros" primero)
            remainingStudents.sort((a, b) => b.delta - a.delta);
            
            for (const student of remainingStudents) {
                // Buscar un grupo que necesite este perfil primario
                const targetGroup = groups.find(group => 
                    group.members.length < group.size && 
                    !group.profiles[student.primaryProfile]
                );
                
                if (targetGroup) {
                    // Asignar estudiante con su perfil primario
                    assignStudentToGroup(student, targetGroup, student.primaryProfile, 1);
                    
                    // Marcar que el grupo ya tiene este perfil
                    targetGroup.profiles[student.primaryProfile] = true;
                }
            }
            
            // Actualizar lista de estudiantes restantes
            remainingStudents = remainingStudents.filter(s => !s.assignedGroup);
            
            // FASE 2: Asignar perfiles secundarios para estudiantes restantes
            for (const student of remainingStudents) {
                // Buscar un grupo que necesite este perfil secundario
                const targetGroup = groups.find(group => 
                    group.members.length < group.size && 
                    !group.profiles[student.secondaryProfile]
                );
                
                if (targetGroup) {
                    // Asignar estudiante con su perfil secundario
                    assignStudentToGroup(student, targetGroup, student.secondaryProfile, 2);
                    
                    // Marcar que el grupo ya tiene este perfil
                    targetGroup.profiles[student.secondaryProfile] = true;
                }
            }
            
            // Actualizar lista de estudiantes restantes
            remainingStudents = remainingStudents.filter(s => !s.assignedGroup);
            
            // FASE 3: Asignar los estudiantes restantes (generalmente integradores) a grupos disponibles
            for (const student of remainingStudents) {
                // Buscar cualquier grupo con espacio disponible
                const targetGroup = groups.find(group => group.members.length < group.size);
                
                if (targetGroup) {
                    // Determinar qué perfil asignar (priorizar primario, luego secundario, luego terciario)
                    let assignedProfile = student.primaryProfile;
                    let roleType = 1;
                    
                    // Si el grupo ya tiene ese perfil, intentar con el secundario
                    if (targetGroup.profiles[assignedProfile]) {
                        assignedProfile = student.secondaryProfile;
                        roleType = 2;
                        
                        // Si el grupo ya tiene ese también, usar el terciario
                        if (targetGroup.profiles[assignedProfile]) {
                            assignedProfile = student.tertiaryProfile;
                            roleType = 3;
                        }
                    }
                    
                    // Asignar estudiante
                    assignStudentToGroup(student, targetGroup, assignedProfile, roleType);
                    
                    // Marcar que el grupo ya tiene este perfil (si no lo tenía ya)
                    targetGroup.profiles[assignedProfile] = true;
                }
            }
            
            // FASE 4: Asegurar que todos los grupos estén completos
            // (En este punto, todos los estudiantes deberían estar asignados)
        }

        function assignStudentToGroup(student, group, role, roleType) {
            student.assignedGroup = group.id;
            student.assignedRole = role;
            student.roleType = roleType;
            
            group.members.push({
                id: student.id,
                name: student.name,
                role: role,
                roleType: roleType,
                isIntegrator: student.isIntegrator,
                primaryProfile: student.primaryProfile
            });
        }

        function displayResults() {
            // Mostrar tarjeta de resultados
            resultsCard.classList.remove('hidden');
            
            // Mostrar grupos
            groupsContainer.innerHTML = '';
            
            groups.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'group-card';
                
                // Determinar qué perfiles tiene el grupo
                const groupProfiles = Object.entries(group.profiles)
                    .filter(([profile, has]) => has)
                    .map(([profile]) => profile);
                
                groupElement.innerHTML = `
                    <div class="group-header">
                        <div class="group-title">Grupo ${group.id}</div>
                        <div class="group-size">${group.members.length} / ${group.size}</div>
                    </div>
                    <div style="margin-bottom: 10px; font-size: 0.9rem; color: #7f8c8d;">
                        <i class="fas fa-user-tag"></i> Perfiles: ${groupProfiles.join(', ')}
                    </div>
                    <ul class="student-list">
                        ${group.members.map(member => `
                            <li class="student-item">
                                <div class="student-name">
                                    ${member.name}
                                    ${member.isIntegrator ? '<span class="role-badge integrator">Integrador</span>' : ''}
                                </div>
                                <div>
                                    <span class="role-badge role-${member.roleType}">
                                        ${member.role} (${member.roleType === 1 ? 'P' : member.roleType === 2 ? 'S' : 'T'})
                                    </span>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                `;
                
                groupsContainer.appendChild(groupElement);
            });
            
            // Mostrar tabla de estudiantes
            studentsTableBody.innerHTML = '';
            
            // Primero mostrar estudiantes con datos completos
            validStudentsData.forEach(student => {
                const row = document.createElement('tr');
                
                // Determinar clase para resaltar integradores
                const integratorClass = student.isIntegrator ? 'integrator' : '';
                
                // Determinar color para el puntaje más alto
                const maxScore = Math.max(
                    student.clarificador, 
                    student.ideador, 
                    student.desarrollador, 
                    student.implementador
                );
                
                row.innerHTML = `
                    <td class="${integratorClass}">${student.name}</td>
                    <td>${student.clarificador === maxScore ? `<strong>${student.clarificador}</strong>` : student.clarificador}</td>
                    <td>${student.ideador === maxScore ? `<strong>${student.ideador}</strong>` : student.ideador}</td>
                    <td>${student.desarrollador === maxScore ? `<strong>${student.desarrollador}</strong>` : student.desarrollador}</td>
                    <td>${student.implementador === maxScore ? `<strong>${student.implementador}</strong>` : student.implementador}</td>
                    <td>${student.primaryProfile}</td>
                    <td>${student.secondaryProfile}</td>
                    <td><strong>Grupo ${student.assignedGroup}</strong></td>
                    <td>
                        <span class="role-badge role-${student.roleType}">
                            ${student.assignedRole} (${student.roleType === 1 ? 'Primario' : student.roleType === 2 ? 'Secundario' : 'Terciario'})
                        </span>
                    </td>
                    <td><span class="role-badge" style="background-color: #d5f4e6; color: #27ae60;">Incluido</span></td>
                `;
                
                studentsTableBody.appendChild(row);
            });
            
            // Luego mostrar estudiantes excluidos (si los hay)
            excludedStudentsData.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'incomplete-data';
                
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.clarificador === undefined || student.clarificador === null || student.clarificador === '' ? '<em>sin dato</em>' : student.clarificador}</td>
                    <td>${student.ideador === undefined || student.ideador === null || student.ideador === '' ? '<em>sin dato</em>' : student.ideador}</td>
                    <td>${student.desarrollador === undefined || student.desarrollador === null || student.desarrollador === '' ? '<em>sin dato</em>' : student.desarrollador}</td>
                    <td>${student.implementador === undefined || student.implementador === null || student.implementador === '' ? '<em>sin dato</em>' : student.implementador}</td>
                    <td><em>N/A</em></td>
                    <td><em>N/A</em></td>
                    <td><em>N/A</em></td>
                    <td><em>N/A</em></td>
                    <td><span class="role-badge" style="background-color: #f9f9f9; color: #999;">Excluido</span></td>
                `;
                
                studentsTableBody.appendChild(row);
            });
            
            // Desplazar hasta los resultados
            resultsCard.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>